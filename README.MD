# üìå API Documentation - Cantine Connect

## üõ†üñ• Technologies et Packages Utilis√©s

- Node.js avec Express.js
- PostgreSQL avec Prisma ORM
- JWT-Passport pour l‚Äôauthentification
- Cloudinary pour stocker les images
- Cors pour bloquer les origines inconnues

## üîê Authentification

### Connexion Parent/Agent/Admin

#### Endpoint

```http
  POST /api/auth/login
```

#### Donn√©es attendues

```json
{
  "email": "parent@example.com",
  "password": "motdepasse",
  "role": "parent"
}
```

#### R√©ponses possibles

**200 OK : Connexion en tant que Parent/Agent/Admin r√©ussie.**

```json
{
  "message": "Connexion r√©ussie",
  "token": "jwt_token",
  "user": {
    "id": 12,
    "role": "parent",
    "name": "Jean Dupont"
  }
}
```

**403 Forbidden : Email ou mot de passe incorrect.**

```json
{
  "error": "Identifiants incorrects"
}
```

**500 Internal Server Error : Bug backend.**

```json
{
  "error": "Erreur serveur"
}
```

### D√©connexion

**Endpoint**:
`POST /api/auth/logout`

#### R√©ponses possibles

**200 OK : D√©connexion r√©ussie.**

```json
{
  "message": "D√©connexion r√©ussie"
}
```

**401 Unauthorized : Utilisateur non identifi√©/connect√©.**

```json
{
  "error": "Vous n'√™tes pas autoris√© √† effectuer cette t√¢che."
}
```

**500 Internal Server Error : Bug backend.**

```json
{
  "error": "Erreur serveur"
}
```

---

## üéì Gestion des √âl√®ves

### Liste des √©l√®ves inscrits √† la Cantine Connect (Admin)

#### Endpoint

```http
  GET /api/students?page=1&limit=10
```

| Param√®tre | Type     | Description        | D√©faut |
| --------- | -------- | ------------------ | ------ |
| `page`    | `String` | La page demand√©e   | 1      |
| `limit`   | `String` | La limite par page | 10     |

#### R√©ponses possibles

**200 OK: Liste des √©l√®ves.**

```json
[
  {
    "id": 1,
    "name": "Paul Mbuya",
    "class": "6√®me B",
    "matriculeHashe": "cfgdhe-tydevhazedfvhj-vdgh67UIB-ejhb3hbbHD",
    "abonnement": {
      "status": "actif",
      "duration": 3, // 3 jours
      "expiration": "2025-03-10"
    },
    "historiqueRepas": [
      { "date": "2025-03-01", "status": true },
      { "date": "2025-03-02", "status": false }
    ]
  }
]
```

**401 Unauthorized : L‚Äôutilisateur n‚Äôa pas les permissions.**

```json
{
  "error": "Acc√®s refus√©"
}
```

**500 Internal Server Error : Bug backend.**

```json
{
  "error": "Erreur serveur"
}
```

### D√©tails d'un √©l√®ve sp√©cifique

**Endpoint**:
`GET /api/students/${id}`

| Param√®tre | Type     | Description                 |
| :-------- | :------- | :-------------------------- |
| `id`      | `string` | **Required**. Id de l'√©l√®ve |

#### R√©ponses possibles

**200 OK: D√©tail d'un l'√©l√®ve.**

```json
{
  "id": 1,
  "name": "Paul Mbuya",
  "class": "6√®me B",
  "matriculeHashe": "cfgdhe-tydevhazedfvhj-vdgh67UIB-ejhb3hbbHD",
  "abonnement": {}
}
```

**403 Forbidden : L‚Äôutilisateur n‚Äôa pas les permissions.**

```json
{
  "error": "Acc√®s refus√©"
}
```

**500 Internal Server Error : Bug backend.**

```json
{
  "error": "Erreur serveur"
}
```

## üçΩÔ∏è Gestion des Abonnements Cantine

### Achat d‚Äôun abonnement (Par le Parent)

**Endpoint**:
`POST /api/students/${matriculeHashe}/abonnements`

| Param√®tre        | Type     | Description                             |
| :--------------- | :------- | :-------------------------------------- |
| `matriculeHashe` | `string` | **Required**. matriculeHash√© de l'√©l√®ve |

**Body attendu (JSON)**:

```json
{
  "duration": 3, //3 jours
  "price": 5000 //5000 fc
}
```

{
"error": "Un abonnement est d√©j√† actif pour cet √©l√®ve"
}
**_De pr√©ference faire une v√©rification au front pour voir si l'√©l√®ve a d√©j√† un abonnement actif et avertir le Parent._**

#### R√©ponses possibles

**200 OK: Achat r√©ussi avec Succ√®s.**

```json
{
  "message": "Abonnement activ√© pour 3 jours",
  "user": {
    "id": 1,
    "name": "Paul Mbuya",
    "class": "6√®me B",
    "abonnement": {}
  }
}
```

**400 Bad Request : Dur√©e absente ou invalide.**

```json
{
  "error": "Dur√©e invalide"
}
```

**401 Unauthorized : L‚Äôutilisateur n‚Äôa pas les permissions.**

```json
{
  "error": "Acc√®s refus√©"
}
```

**404 Not Found : Aucun utilisateur trouv√©.**

```json
{
  "error": "Aucun utilisateur trouv√©"
}
```

**500 Internal Server Error : Bug backend.**

```json
{
  "error": "Erreur serveur"
}
```

## üçΩÔ∏è Gestion des Repas (Scan QR Code)

### L'Agent scanne un QRCode d‚Äô√©l√®ve

#### Endpoint

`POST /api/students/scan`

**Body attendu (JSON)**:

```json
{
  "matriculeHashe": "cfgdhe-tydevhazedfvhj-vdgh67UIB-ejhb3hbbHD"
}
```

#### R√©ponses possibles

**200 OK: Repas valid√© avec Succ√®s.**

```json
{
  "message": "Repas valid√©",
  "user": {
    "id": 1,
    "name": "Paul Mbuya",
    "class": "6√®me B",
    "abonnement": {}
  }
}
```

**400 Bad Request : Pas d‚Äôabonnement actif.**

```json
{
  "error": "Pas d‚Äôabonnement actif"
}
```

**404 Not Found : √âl√®ve non inscrit √† la Cantine.**

```json
{
  "error": "√âl√®ve non inscrit √† la Cantine"
}
```

**500 Internal Server Error : Bug backend.**

```json
{
  "error": "Erreur serveur"
}
```

## üìä Affichage de l‚ÄôHistorique

### R√©cup√©ration de l‚Äôhistorique des repas

#### Endpoint

`GET /api/students/${id}/historique-repas`

| Param√®tre | Type     | Description                 |
| :-------- | :------- | :-------------------------- |
| `id`      | `string` | **Required**. Id de l'√©l√®ve |

Ajout possible : Ajout des filtres pour permettre aux parents de consulter l'historique sur une p√©riode sp√©cifique.
Exemple : `GET /api/students/${id}/historique-repas?startDate=2025-03-01&endDate=2025-03-31`

#### R√©ponses possibles

**200 OK: Envoi de l'historique.**

```json
{
  "calendar": [
    { "date": "2025-03-01", "status": true },
    { "date": "2025-03-02", "status": false },
    { "date": "2025-03-03", "status": false },
    { "date": "2025-03-04", "status": null }
  ]
}
```

**Commentaires:**
üìÖ null ‚Üí Week-end & absence √† la Cantine (fond gris)
‚úÖ true ‚Üí A mang√© (fond vert)
‚ùå false ‚Üí N‚Äôa pas mang√© car on l'a scanner et on a vu que l'√©l√®ve n'avait pas d'abonnement (fond rouge)

**404 Not Found : √âl√®ve non inscrit √† la Cantine.**

```json
{
  "error": "√âl√®ve non inscrit √† la Cantine"
}
```

**500 Internal Server Error : Bug backend.**

```json
{
  "error": "Erreur serveur"
}
```

## üì¢ Notifications Parents

### R√©cup√©rer toutes les notifications

#### Endpoint

`GET /api/students/${id}/notifications?page=1&limit=10`

| Param√®tre | Type     | Description        | D√©faut |
| --------- | -------- | ------------------ | ------ |
| `page`    | `String` | La page demand√©e   | 1      |
| `limit`   | `String` | La limite par page | 10     |

#### R√©ponses possibles

**200 OK: Envoi des notifications.**

**Notif type Repas:**

```json
[
  {
    "id": 1,
    "message": "Votre enfant a mang√© aujourd'hui le 03/03/2025 √† 15H34",
    "type": "repas",
    "details": {
      "date": "2025-03-03T15:34:00Z",
      "status": true
    },
    "read": false,
    "timestamp": "2025-03-03T15:34:00Z"
  }
]
```

**Notif type Achat d'Abonnement:**

```json
{
  "id": 1,
  "studentId": 1,
  "message": "Abonnement de 30 jours achet√© pour 70000fc",
  "type": "abonnement",
  "details": {
    "duration": 30,
    "price": 70000,
    "endDate": "2025-03-31T00:00:00Z"
  },
  "read": false,
  "createdAt": "2025-03-01T12:00:00Z"
}
```

**Notif type Expiration d'Abonnement:**

```json
{
  "id": 2,
  "studentId": 1,
  "message": "Votre abonnement expire dans 12 heures",
  "type": "expiration",
  "details": { "endDate": "2025-03-31T00:00:00Z" },
  "read": false,
  "createdAt": "2025-03-30T12:00:00Z"
}
```

**401 Unauthorized : L‚Äôutilisateur n‚Äôa pas les permissions.**

```json
{
  "error": "Acc√®s refus√©"
}
```

**404 Not Found : Aucun utilisateur trouv√©.**

```json
{
  "error": "Aucun utilisateur trouv√©"
}
```

**500 Internal Server Error : Bug backend.**

```json
{
  "error": "Erreur serveur"
}
```

## üìö Documentation Suppl√©mentaire

### Erreurs Communes et Solutions

Cette section explique les erreurs courantes que vous pourriez rencontrer lors de l'utilisation de l'API **CantineConnect**, ainsi que des conseils pour les r√©soudre.

---

#### 400 Bad Request

- **Cause** : La requ√™te est mal formul√©e ou contient des donn√©es invalides.
- **Exemples :**
  - Un champ obligatoire est manquant (par exemple, `email` ou `password`).
  - Une valeur est dans un format incorrect (par exemple, une date au lieu d'un nombre).
- **Solution :**

  - V√©rifiez que tous les champs obligatoires sont pr√©sents dans la requ√™te.

  - Assurez-vous que les donn√©es sont dans le bon format (par exemple, un email valide, un nombre pour un champ de prix, etc.).

  - Consultez la documentation pour conna√Ætre les formats attendus.

---

#### 401 Unauthorized

- **Cause** : L'utilisateur n'est pas autoris√© √† acc√©der √† la ressource demand√©e.
- **Exemples :**
  - Le token JWT est manquant, expir√© ou invalide.
  - L'utilisateur tente d'acc√©der √† une ressource r√©serv√©e √† un autre r√¥le (par exemple, un parent essayant d'acc√©der √† une fonctionnalit√© admin).
- **Solution :**
  - V√©rifiez que vous √™tes connect√© et que votre token JWT est valide.
  - Assurez-vous que vous utilisez le bon r√¥le (parent, agent ou admin) pour acc√©der √† la ressource.
  - Si le token est expir√©, d√©connectez-vous et reconnectez-vous pour en obtenir un nouveau.

---

#### 403 Forbidden

- **Cause** : L'utilisateur n'a pas les permissions n√©cessaires pour effectuer l'action demand√©e.
- **Exemples :**
  - Un parent tente de modifier les donn√©es d'un autre parent.
  - Un agent tente d'acc√©der √† une fonctionnalit√© r√©serv√©e √† l'admin.
- **Solution :**
  - V√©rifiez que vous avez les droits n√©cessaires pour effectuer cette action.
  - Contactez l'administrateur si vous pensez que c'est une erreur.

---

#### 404 Not Found

- **Cause** : La ressource demand√©e n'existe pas.
- **Exemples :**
  - L'ID d'un √©l√®ve ou d'un abonnement est incorrect.
  - L'URL de l'endpoint est mal orthographi√©e.
- **Solution :**
  - V√©rifiez que l'ID ou l'URL est correct.
  - Assurez-vous que la ressource existe dans la base de donn√©es.

---

#### 500 Internal Server Error

- **Cause** : Une erreur s'est produite c√¥t√© serveur.
- **Exemples :**
  - Un bug dans le code backend.
  - Une panne de la base de donn√©es.
- **Solution :**
  - Contactez l'administrateur syst√®me pour signaler le probl√®me.
  - V√©rifiez les logs du serveur pour plus de d√©tails sur l'erreur.

---

#### Conseils G√©n√©raux

- **Validation des Donn√©es :**
  - Avant d'envoyer une requ√™te, assurez-vous que toutes les donn√©es sont valides et dans le bon format.
  - Utilisez des outils comme Postman pour tester vos requ√™tes avant de les int√©grer dans votre application.
- **Gestion des Tokens :**
  - Stockez le token JWT de mani√®re s√©curis√©e dans les cookies.
  - Rafra√Æchissez le token avant son expiration pour √©viter les interruptions de service.
- **Pagination :**
  - Pour les endpoints qui renvoient des listes (par exemple, la liste des √©l√®ves), utilisez les param√®tres `page` et `limit` pour √©viter de surcharger le serveur.

---

#### Exemple de Requ√™te avec Postman

Voici un exemple de requ√™te pour se connecter en tant que parent :

1. **M√©thode :** `POST`
2. **URL :** `http://votre-domaine/api/auth/login`
3. **Headers :**
   - `Content-Type: application/json`
4. **Body :** (JSON)

```json
{
  "email": "parent@example.com",
  "password": "motdepasse",
  "role": "parent"
}
```

---

#### Support technique

Si vous rencontrez des probl√®mes persistants, contactez l'√©quipe technique √† l'adresse suivante :

- **Email**: <support@cantineconnect.com>
- **T√©l√©phone**: +243 977 873 421

---

## **Workflows de CantineConnect**

---

### **1. Workflow d'Enregistrement d'un √âl√®ve √† la Cantine**

#### **Acteurs** : Admin, Parent

1. **√âtape 1** : Le parent contacte l'Admin pour demander l'enregistrement de son enfant √† la cantine.
2. **√âtape 2** : L'Admin se connecte √† son tableau de bord et s√©lectionne l'√©l√®ve dans la liste des √©l√®ves de l'√©cole (`SchoolStudent`).
3. **√âtape 3** : L'Admin v√©rifie si l'√©l√®ve est d√©j√† inscrit √† la cantine.
4. **√âtape 4** : Si l'√©l√®ve n'est pas encore inscrit :
   - L'Admin cr√©e un enregistrement dans la table `Student`.
   - Un `matriculeHashe` est g√©n√©r√© pour le QR Code.
   - Le QR Code est g√©n√©r√© au format PDF pour impression.
5. **√âtape 5** : L'Admin envoie le PDF au parent pour impression.

---

### **2. Workflow de Cr√©ation d'un Compte Agent**

#### **Acteurs** : Admin

1. **√âtape 1** : L'Admin se connecte √† son tableau de bord.
2. **√âtape 2** : L'Admin cr√©e un nouveau compte agent en renseignant :
   - L'email de l'agent.
   - Un mot de passe temporaire.
3. **√âtape 3** : Le syst√®me envoie un email √† l'agent avec ses informations de connexion.
4. **√âtape 4** : L'agent se connecte et change son mot de passe.

---

### **3. Workflow de Connexion du Parent**

#### **Acteurs** : Parent

1. **√âtape 1** : Le parent se connecte avec son email et son mot de passe.
2. **√âtape 2** : Le syst√®me r√©cup√®re la liste des enfants associ√©s √† ce parent.
3. **√âtape 3** : Le parent voit une interface avec :
   - Une liste de ses enfants.
   - Des options pour g√©rer les abonnements, consulter l'historique, etc.

---

### **4. Workflow d'Achat d'Abonnement**

#### **Acteurs** : Parent

1. **√âtape 1** : Le parent s√©lectionne un enfant dans la liste.
2. **√âtape 2** : Le parent choisit une dur√©e d'abonnement (1, 3, 7 ou 30 jours).
3. **√âtape 3** : Le syst√®me calcule le prix en fonction de la dur√©e :
   - 1 jour = 2000fc
   - 3 jours = 7000fc
   - 7 jours = 15000fc
   - 30 jours = 70000fc
4. **√âtape 4** : Un enregistrement est cr√©√© dans la table `Abonnement` avec :
   - La dur√©e et le prix.
   - Les dates de d√©but et de fin.
   - Le statut "actif".
5. **√âtape 5** : Le parent re√ßoit une notification avec les d√©tails de l'abonnement.

---

### **5. Workflow de Scan du QR Code**

#### **Acteurs** : Agent, Parent

1. **√âtape 1** : L'agent scanne le QR Code de l'√©l√®ve.
2. **√âtape 2** : Le syst√®me v√©rifie :
   - Si l'√©l√®ve a un abonnement actif.
   - Si l'√©l√®ve n'a pas d√©j√† √©t√© servi aujourd'hui.
3. **√âtape 3** :
   - Si tout est valide, un enregistrement est cr√©√© dans la table `Repas` avec `status: true`.
   - Si l'abonnement est expir√©, un enregistrement est cr√©√© avec `status: false`.
4. **√âtape 4** : Le parent re√ßoit une notification indiquant si l'enfant a √©t√© servi ou non.

---

### **6. Workflow de Gestion des Notifications**

#### **Acteurs** : Parent

1. **Types de Notifications** :
   - **Achat d'abonnement** : D√©tails de l'op√©ration (montant, dur√©e, etc.).
   - **Scan du QR Code** : Confirmation du repas pris ou non.
   - **Expiration d'abonnement** : Rappel 12 heures avant la fin de l'abonnement.
2. **Marquage comme Lu** :
   - Lorsqu'un parent ouvre une notification, le champ `read` est mis √† `true`.

---

### **7. Workflow de R√©cup√©ration de l'Historique des Repas**

#### **Acteurs** : Parent

1. **√âtape 1** : Le parent s√©lectionne un enfant dans la liste.
2. **√âtape 2** : Le syst√®me renvoie un calendrier avec :
   - `true` : Repas pris (fond vert).
   - `false` : Repas non pris (fond rouge).
   - `null` : Week-end ou absence (fond gris).
3. **Filtres** :
   - Le parent peut filtrer par p√©riode (ex: du 01/03/2025 au 31/03/2025).

---

### **8. Workflow de Gestion des Utilisateurs (Admin)**

#### **Acteurs** : Admin

1. **Cr√©ation de Comptes** :
   - L'Admin peut cr√©er des comptes pour les parents, les agents et les autres admins.
2. **Gestion des √âl√®ves** :
   - L'Admin peut consulter la liste de tous les √©l√®ves de l'√©cole (`SchoolStudent`).
   - L'Admin peut enregistrer des √©l√®ves √† la cantine (`Student`).
3. **Statistiques** :
   - L'Admin peut consulter des statistiques globales (nombre de repas servis, abonnements actifs, etc.).

---

### **9. Workflow de Notification d'Expiration d'Abonnement**

#### **Acteurs** : Syst√®me, Parent

1. **√âtape 1** : Le syst√®me v√©rifie les abonnements actifs.
2. **√âtape 2** : Si un abonnement expire dans 12 heures :
   - Le syst√®me envoie une notification au parent.
3. **√âtape 3** : Le parent re√ßoit une notification :

```json
{
  "message": "Votre abonnement pour Paul Mbuya expire dans 12 heures",
  "type": "expiration",
  "details": { "endDate": "2025-03-31T00:00:00Z" }
}
```

---

### **10. Workflow de Consultation des Statistiques (Admin)**

#### **Acteurs** : Admin

1. **√âtape 1** : L'Admin se connecte √† son tableau de bord.
2. **√âtape 2** : L'Admin consulte les statistiques globales :
   - Nombre de repas servis par jour/semaine/mois.
   - Nombre d'abonnements actifs.
   - Nombre d'√©l√®ves inscrits √† la cantine.
3. **√âtape 3** : L'Admin peut exporter ces donn√©es au format PDF ou Excel.

---

### **R√©sum√© des Workflows**

| **Workflow**                     | **Acteurs**     | **Description**                                                                  |
| -------------------------------- | --------------- | -------------------------------------------------------------------------------- |
| Enregistrement d'un √©l√®ve        | Admin, Parent   | L'Admin enregistre un √©l√®ve √† la cantine et g√©n√®re un QR Code.                   |
| Cr√©ation d'un compte agent       | Admin           | L'Admin cr√©e un compte agent et envoie les informations de connexion.            |
| Connexion du parent              | Parent          | Le parent se connecte et voit la liste de ses enfants.                           |
| Achat d'abonnement               | Parent          | Le parent ach√®te un abonnement pour un enfant.                                   |
| Scan du QR Code                  | Agent, Parent   | L'agent scanne le QR Code et valide le repas.                                    |
| Gestion des notifications        | Parent          | Le parent re√ßoit et consulte les notifications.                                  |
| Historique des repas             | Parent          | Le parent consulte l'historique des repas pour un enfant.                        |
| Gestion des utilisateurs (Admin) | Admin           | L'Admin cr√©e et g√®re les comptes des parents, agents et admins.                  |
| Notification d'expiration        | Syst√®me, Parent | Le syst√®me envoie une notification 12 heures avant l'expiration d'un abonnement. |
| Consultation des statistiques    | Admin           | L'Admin consulte les statistiques globales de la cantine.                        |
